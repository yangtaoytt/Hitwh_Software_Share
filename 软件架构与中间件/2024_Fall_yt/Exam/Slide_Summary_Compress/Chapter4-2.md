# Chapter4-2

### 1. 数据库和数据库实例区别与联系

**区别**： (1) 数据库是文件的集合，是依照某种数据模型组织起来并存放于二级存储器中的数据集合； (2) 数据库实例是程序，是位于用户和操作系统之间的一层数据管理软件，用户对数据库中的数据做任何的操作，包括数据定义、数据查询、数据维护、数据库运行控制等等都是在数据库实例下进行的，应用程序只有通过数据库实例才能和数据库进行交互。**联系**：数据库是由文件组成（一般来说都是二进制文件）的，一般不可能直接对这些二进制文件进行操作，以实现数据库的SELECT、UPDATE、INSERT和DELETE操作，需要数据库实例来完成对数据库的操作。

### 2. 分库分表的定义

分库分表的本质是数据拆分，是对数据进行分而治之的通用概念。为了分散数据库的压力，采用分库分表将一个表结构分为多个表，或者将一个表的数据分片后放入多个表，这些表可以放在同一个库里，也可以放到不同的库里，甚至可以放在不同的数据库实例上。

### 3. 数据拆分分类

(1) 垂直拆分：根据业务的维度，将原本的一个库（表）拆分为多个库（表），每个库（表）与原有的结构不同。  (2) 水平拆分：根据分片（sharding）算法，将一个库（表）拆分为多个库（表），每个库（表）依旧保留原有的结构。

### 4. 分库分表的发展阶段

(1) 单库单表。  (2) 单库多表:单表内数据越来越多，查询性能下降，有锁表的可能，并阻塞所有其他的操作  (3) 多库多表:单台数据库的存储空间不够用，增加和减少索引消耗时间过长。对数据库进行水平切分，将切分的数据库和表水平地分散到不同的数据库实例上。

### 5. 分库分表的操作时机

(1) 如果在数据库中表的数量达到了一定量级，则需要进行分表，分解单表的大数据量对索引查询带来的压力，并方便对索引和表结构的变更  (2) 如果数据库的吞吐量达到了瓶颈，就需要增加数据库实例，利用多个数据库实例来分解大量的数据库请求带来的系统压力  (3) 如果希望在扩容时对应用层的配置改变最少，就需要在每个数据库实例中预留足够的数据库数量

### 6. 客户端分片的定义

客户端分片就是使用分库分表的数据库的应用层直接操作分片逻辑，分片规则需要在同一个应用的多个节点间进行同步，每个应用层都嵌入一个操作切片的逻辑实现，一般通过依赖Jar包来实现。

### 7. 客户端分片实现方式

应用层/定制JDBC/ORM框架

### 8. 应用层实现方式

(1) 直接在应用层读取分片规则，然后解析分片规则，据此实现切分的路由逻辑，从应用层直接决定每次操作应该使用哪个数据库实例、库、表等。  (2) 需要侵入业务，但实现简单，适合快速上线，切分逻辑由开发者自行定义，容易调试维护。但要求开发者既要实现业务逻辑，还需要实现框架需求。  (3) 该实现方式会让数据库保持的连接比较多，对整体应用服务器池的维护将造成压力。

### 9. 定制JDBC实现方式

(1) 可让开发者集中精力实现业务逻辑，无须关心分库分表的实现。  (2) 通过定制JDBC协议来实现，也就是针对业务逻辑层提供与JDBC一致的接口，分库分表在JDBC的内部实现。  (3) 开发者需要理解JDBC协议，流行的框架有Sharding JDBC

### 10. 通过定制ORM实现

分片规则实现到ORM框架（介于上述两者间）中或者通过ORM框架支持的扩展机制来完成分库分表的逻辑。

### 11. 代理分片定义和好处坏处

代理分片就是在应用层和数据库层之间增加一个代理层，把分片的路由规则配置在代理层，代理层对外提供与JDBC兼容的接口给应用层。  **好处**：应用层的开发人员不用关心分片规则，只需关心业务逻辑的实现，待业务逻辑实现之后，在代理层配置路由规则即可。  **坏处**：  (1) 代理层的引入增加了一层网络传输，对性能会造成影响。  (2) 需要维护代理层，增加了人员和硬件的成本。

### 12. 垂直切分定义和分类

垂直切分是指按照业务将表进行分类或分拆，将其分布到不同数据库上。  **分类**：按业务进行分库和按业务进行分表。

### 13. 分开的不同方法

(1) 不同业务模块的数据可以分散到不同数据库服务器。  (2) 也可以冷热分离，根据数据的活跃度将数据进行拆分。冷数据：变化更新频率低，查询次数多的数据。热数据：变化更新频率高，活跃的数据。  (3) 也可以人为将一个表中的内容划分为多个表，例如将查询较多，变化不多的字段拆分成一张表放在查询性能高的服务器，而将频繁更新的字段拆分并部署到更新性能高的服务器。

### 14. 垂直切分优缺点

**优点**：(1) 拆分后业务清晰，拆分规则明确  (2) 系统之间进行整合或扩展很容易  (3) 按照成本、应用的等级或类型等将表放到不同的机器上，便于管理  (4) 便于实现动静分离、冷热分离的数据库表的设计模式  (5) 数据维护简单**缺点**：(1) 部分业务表无法关联（Join），只能通过接口方式解决，提高了系统的复杂度  (2) 受每种业务的不同限制，存在单库性能瓶颈，不易进行数据扩展和提升性能  (3) 事务处理复杂

### 15. 水平切分定义

水平切分不是将表进行分类，而是将其按照某个字段的某种规则分散到多个库中，在每个表中包含一部分数据，所有表加起来是全量数据。简言之，将数据按一定规律，按行切分，并分配到不同的库表里，表结构完全一样。

### 16. 水平切分优缺点

**优点**：(1) 单库单表的数据保持在一定的量级，有助于性能的提高  (2) 切分的表的结构相同，应用层改造较少，只需要增加路由规则即可  (3) 提高了系统的稳定性和负载能力**缺点**：(1) 切分后，数据是分散的，很难利用数据库的Join操作，跨库Join性能差  (2) 拆分规则难以抽象  (3) 分片事务的一致性难以解决  (4) 数据扩容的难度和维护量极大

### 17. 垂直/水平切分的共同点和偏向

**共同点**(1) 存在分布式事务的问题  (2) 存在跨节点Join的问题  (3) 存在跨节点合并排序、分页的问题  (4) 存在多数据源管理的问题**偏向**(1) 垂直切分更偏向于业务拆分的过程  (2) 水平切分更偏向于技术性能指标

### 18. 水平切分的路由过程

(1) 分库分表后，数据将分布到不同的分片表中，通过分库分表规则查找到对应的表和库的过程叫做路由。  (2) 我们在设计表时需要确定对表按照什么样的规则进行分库分表。

### 19. 水平切分的分片维度

(1) 按哈希切片。对数据的某个字段求哈希，再除以分片总数后取模，取模后相同的数据为一个分片，这样将数据分成多个分片。**好处**：数据切片比较均匀，对数据压力分散的效果较好。**缺点**：数据分散后，对于查询需求需要进行聚合处理  (2) 按照时间切片。按照时间的范围将数据分布到不同的分片。

### 20. 分库分表引起的问题

(1) 扩容与迁移问题。  (2) 查询问题  (3) 分布式事务问题。多库多表分布式所引发的一致性问题。  (4) 同组数据跨库问题。要尽量把同一组数据放到同一台数据库服务器上，不但在某些场景下可以利用本地事务的强一致性，还可以使这组数据实现自治。

### 21. 扩容与迁移

(1) 按照新旧分片规则，对新旧数据库进行双写  (2) 将双写前按照旧分片规则写入的历史数据，根据新分片规则迁移写入新的数据库  (3) 将按照旧的分片规则查询改为按照新的分片规则查询  (4) 将双写数据库逻辑从代码中下线，只按照新的分片规则写入数据  (5) 删除按照旧分片规则写入的历史数据

### 22. 扩容与迁移的问题

(一)**数据一致性问题**。（1）由于数据量大，通常会造成不一致问题，因此，通常先清理旧数据，洗完后再迁移到新规则的新数据库下，再做全量对比。还需要对比评估迁移过程中是否有数据更新，如果有需要迭代清洗，直至一致。（2）如果数据量巨大，无法全量对比，需要抽样对比，抽样特征需要根据业务特点进行选取。（3）线上记录迁移过程中的更新操作日志，迁移后根据更新日志与历史数据共同决定数据的最新状态，以达到迁移数据的最终一致性。（二）**动静数据分离问题**。对于一些动静敏感的数据，如交易数据，最好将动静数据分离。选取时间点对静历史数据进行迁移。

### 23. 查询问题定义和解决方案

在分库分表以后，如果查询的标准是分片的主键，则可以通过分片规则再次路由并查询，但是对于其他主键的查询、范围查询、关联查询、查询结果排序等，并不是按照分库分表维度来查询的。**查询问题的解决方案**：(1) 在多个分片表查询后合并数据集（效率很低）  (2) 按查询需求定义多分片维度，形成多张分片表（空间换时间）  (3) 通过搜索引擎解决，如果有实时要求，还需要实时搜索。（难度大）
