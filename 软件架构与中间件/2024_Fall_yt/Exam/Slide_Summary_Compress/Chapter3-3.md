# Chapter3-3

### 1. 为什么要设计高性能集群/负载均衡

单服务器有性能天花板，无论如何优化，无论采用多好的硬件，总会有一个上限，当无法满足业务需求时，就需要设计高性能集群来提升系统整体的处理性能.

### 2. 高性能集群的复杂性

高性能集群的复杂性主要体现在需要增加一个任务分配器（负载均衡器）以及为任务选择一个合适的任务分配算法.

### 3. 常见的负载均衡器

(1) DNS负载均衡. (2) 硬件负载均衡. (3) 软件负载均衡.

### 4. DNS负载均衡定义

DNS是最简单也是最常见的负载均衡方式，一般用来实现地理级别的均衡.

### 5. DNS负载均衡的优缺点

**$$** **优点**: (1) 简单、成本低：交给DNS服务器处理，无须自己开发、维护负载均衡设备.; (2) 就近访问，提升访问速度：DNS解析时可以根据请求来源IP，解析成距离用户最近的服务器地址，可以加快访问速度，改善性能.**$$** **缺点**: (1) **更新不及时**：DNS缓存的时间比较长，修改DNS配置后，还是有很多用户会继续访问修改前的IP，这样的访问会失败，达不到负载均衡的目的，并且也影响用户正常使用业务.; (2) **扩展性差**：DNS负载均衡的控制权在域名商那里，无法根据业务特点针对其做更多的定制化功能和扩展特性.; (3) **分配策略比较简单**：DNS负载均衡支持的算法少；不能区分服务器的差异（不能根据系统与服务的状态来判断负载）；也无法感知后端服务器的状态.

### 6. 硬件负载均衡的定义

硬件负载均衡通过单独的硬件设备来实现负载均衡功能.

### 7. 硬件负载均衡的优缺点

**$$** **优点**: (1) **功能强大**：全面支持各层级的负载均衡，支持全面的负载均衡算法，支持全局负载均衡.; (2) **性能强大**.; (3) **稳定性高**：商用硬件负载均衡，经过了良好的严格测试，经过大规模使用，稳定性高.; (4) **支持安全防护**：硬件均衡设备除具备负载均衡功能外，还具备防火墙、防DDoS攻击等安全功能.**$$** **缺点**: (1) **价格昂贵**.; (2) **扩展能力差**：硬件设备，可以根据业务进行配置，但无法进行扩展和定制.

### 8. 软件负载均衡的定义

软件负载均衡通过负载均衡软件来实现负载均衡功能，常见的有Nginx和LVS，Nginx是7层负载均衡，LVS是Linux内核的4层负载均衡，4层和7层的区别就在于协议和灵活性，Nginx支持HTTP、E**$$**mail协议，而LVS是4层负载均衡，和协议无关，几乎所有应用都可以做，例如，聊天、数据库等.

### 9. 软件和硬件方法的区别

软件和硬件负载均衡方法的最主要区别就在于性能。硬件负载均衡性能远远高于软件负载均衡性能。Nginx性能是万级，LVS的性能是十万级，而F5性能是百万级.

### 10. 软件负载均衡的实现

(1) 使用开源的系统进行负载均衡.; (2) 如果业务比较特殊，也可能基于开源系统进行定制（例如，Nginx插件），甚至进行自研.

### 11. 软件负载均衡的优缺点

**$$** **优点**: (1) **简单**：无论是部署还是维护都比较简单.; (2) **便宜**：只要买个Linux服务器，装上软件即可.; (3) **灵活**：4层和7层负载均衡可以根据业务进行选择；也可以根据业务进行比较方便的扩展，例如，可以通过Nginx的插件来实现业务的定制化功能.**$$** **与硬件负载均衡相比的缺点**: (1) 性能一般.; (2) 功能没有硬件负载均衡那么强大.; (3) 一般不具备防火墙和防DDoS攻击等安全功能.

### 12. 负载均衡的典型架构

(1) **地理级别负载均衡**：当用户访问时，DNS会根据用户的地理位置来决定返回哪个机房的IP. (2) **集群级别负载均衡**：F5收到请求后，进行集群级别的负载均衡. (3) **机器级别的负载均衡**：Nginx收到用户请求后，将用户请求发送给集群里面的某台服务器.

### 13. 负载均衡算法分类

根据算法期望达到的目的，大体上可以分为下面几类:

(1) **任务数平分类**：负载均衡系统将收到的任务平均分配给服务器进行处理，这里的“平均”可以是绝对数量的平均，也可以是比例或者权重上的平均.; (2) **负载均衡类**：负载均衡系统根据服务器的负载来进行分配，用连接数、I/O使用率、网卡吞吐量等来衡量系统的压力.; (3) **性能最优类**：负载均衡系统根据服务器的响应时间来进行任务分配，优先将新任务分配给响应最快的服务器.; (4) **Hash类**：负载均衡系统根据任务中的某些关键信息进行Hash运算，将相同Hash值的请求分配到同一台服务器上。常见的有源地址Hash、目标地址Hash、session id hash、用户id hash等.

### 14. 轮询的定义

负载均衡系统收到请求后，按照顺序轮流分配到服务器上.

### 15. 轮询的特点及优缺点

(1) 轮询是最简单的一个策略，无须关注服务器本身的状态，例如：某服务器有bug或某服务器能力较强都无视.; (2) “简单”是轮询算法的优点，也是它的缺点.

### 16. 加权轮询的定义

负载均衡系统根据服务器权重进行任务分配，这里的权重一般是根据硬件配置进行静态配置的.

### 17. 加权轮询的特点及优缺点

加权轮询是轮询的一种特殊形式，其主要目的就是为了解决不同服务器处理能力有差异的问题，解决了轮询算法中无法根据服务器的配置差异进行任务分配的问题，但同样存在无法根据服务器的状态差异进行任务分配的问题.

### 18. 负载最低优先的定义

负载均衡系统将任务分配给当前负载最低的服务器。LVS，可以以“连接数”来判断服务器的状态，服务器连接数越大，表明服务器压力越大。Nginx，可以以“HTTP请求数”来判断服务器状态（Nginx内置的负载均衡算法不支持这种方式，需要进行扩展）

### 19. 负载均衡衡量标准分类

(1) 如果是 **CPU密集型**，可以以“CPU负载”来衡量系统压力.; (2) 如果是 **I/O密集型**，可以以“I/O负载”来衡量系统压力.

### 20. 负载最低优先的特点及好处坏处

(1) 解决了轮询算法中无法感知服务器状态的问题，由此带来的代价是复杂度要增加很多.; (2) CPU负载最低优先的算法要求以某种方式收集每个服务器的CPU负载.; (3) 不同业务最优的时间间隔是不一样的，时间间隔太短容易造成频繁波动，时间间隔太长又可能造成峰值来临时响应缓慢.; (4) 负载最低优先算法基本上能够比较完美地解决轮询算法的缺点，可以感知服务器当前的运行状态，其代价是复杂度大幅上升.

负载最低优先算法，看起来很美好，但实际应用场景反而不如轮询（包括加权轮询）.

### 21. 性能最优算法的定义及和负载区别

性能最优优先类算法则是站在客户端的角度来进行分配的，优先将任务分配给处理速度最快的服务器，通过这种方式达到最快响应客户端的目的，负载最低优先类算法是站在服务器的角度来进行分配的.

### 22. 性能最优算法的特点及好处坏处

(1) 性能最优优先类算法本质上也是感知了服务器的状态只是通过响应时间这个外部标准来衡量服务器状态而已.; (2) 复杂度很高，主要体现在：负载均衡系统需要收集和分析每个服务器每个任务的响应时间，在大量任务处理的场景下，这种收集和统计本身也会消耗较多的性能.; (3) 工业上使用采样，并调优采样率.

### 23. Hash类算法的定义

负载均衡系统根据任务中的某些关键信息进行Hash运算，将相同Hash值的请求分配到同一台服务器上，这样做的目的主要是为了满足特定的业务需求.

### 24. Hash算法的分类

(1) **源地址Hash**：将来源于同一个源IP地址的任务分配给同一个服务器进行处理，适合于存在事务、会话的业务.; (2) **ID Hash**：将某个ID标识的业务分配到同一个服务器中进行处理，这里的ID一般是临时性数据的ID（如session id）.