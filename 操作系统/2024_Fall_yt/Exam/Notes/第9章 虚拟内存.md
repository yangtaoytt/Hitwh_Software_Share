### 第9章 虚拟内存

[TOC]

#### 1. 虚拟内存定义
虚拟内存是内存管理的一种技术，它允许执行进程时**不必完全载入内存**，可以**部分程序**载入到内存。

#### 2. 虚拟内存优点
1. **逻辑地址**空间可大于**物理地址**空间。
2. 可以被多个进程**共享地址空间**。
3. 可以提供更有效的**进程创建**。

#### 3. 按需调页的定义
将执行程序从磁盘载入内存（全部、部分），**按执行程序需要**调入页，但暂时**不需要的页不会调入**到物理内存。

#### 4. 按需调页优点
1. 可以**减少 I/O**。
2. 可以**减少内存使用**。
3. 应答**速度快**。

#### 5. 如何区分页是否在内存中？
操作系统需要区分哪些页在物理内存，哪些页在虚拟内存。
- **有效/无效位（valide/invalide）**：
  - **有效（v）**：页在物理内存中。
  - **无效（i）**：页不在物理内存中，即在虚拟内存中。

#### 6. 请求调页/页错误过程
1. 想要访问的页不在内存空间（无效页），会发生**页错误**，并**陷入**操作系统。
2. 确定该访问**是否合法**：
   - 不合法：**结束**进程。
   - 合法：执行以下操作：
     1. 找到一个**空闲帧**。
     2. 将**所需要的页**调入到找到的空闲帧中。
     3. 修改**页表**（有效/无效位），表示该页已在物理内存中。
     4. **重新开始**因陷阱而中断的指令。

#### 7. 写时复制技术 (Copy-on-Write, COW)
1. COW技术允许父进程和子进程**共享物理内存中的页**。
2. 如果任何一个进程需要对页进行写操作，则**创建一个共享页的副本**。
3. **优点**：
   - 可以**快速创建**进程。
   - **最小化**新创建进程的**页数**。

#### 8. 从哪里分配空闲页？
**空闲缓冲池**。

#### 9. 没有空闲页分配怎么办？
可以采取以下方法：
1. **终止**进程。
2. **交换**出一个进程。
3. **页置换**（page replacement）。

#### 10. 页置换的地位
页置换是**按需调页的基础**，它分开了**逻辑内存**和**物理内存**，为程序员提供了巨大的内存空间。

#### 11. 页置换过程
1. 查找所需页在**磁盘上的位置**。
2. 查找一个**空闲帧**：
   - 如果有空闲帧：使用该帧。
   - 如果没有空闲帧：通过**置换算法**选择一个“牺牲”帧。
3. 将所需页读入空闲帧，修改**页表**。
4. **重启**进程。

#### 12. 页置换的问题
页置换发生两次页传输（换入、换出），导致页处理时间加倍，增加了**内存访问时间**。

#### 13. 如何解决页置换问题？
1. **换出优化**：
   - 每个页关联一个**修改位**（modify bit）。
   - 修改位为**真**：换出时**需写入**磁盘。
   - 修改位为**假**：换出时**不需写入**磁盘，避免磁盘操作。
2. **换入优化**：
   - **页缓冲**：系统保留空闲帧缓冲池，牺牲页写出前，先从**空闲帧缓冲池**分配内存。

#### 14. 页置换算法目标
**最小化页错误的发生。**

#### 15. 如何评估页置换算法？
利用引用串评估算法：
- **引用串**：一系列页的序号。
- **评估方式**：检查发生的页错误次数。

#### 16. FIFO问题
**Belady异常**：**更多帧**可能导致**更多页错误**。

#### 17. 最优置换问题？
无法知道引用串的**未来**信息。

#### 18. LRU定义
最近最少使用算法（Least Recently Used）：
- 每个页关联**上次使用的时间**，选择**最长时间未使用**的帧。

#### 19. LRU实现及问题
1. **计数器法**：
   - 页表每项与计数器相连，记录时间。
   - **问题**：
     - 增加访问操作。
     - 增加内存使用。
     - 置换需**搜索全部页表**。
2. **栈法**：
   - 每次引用一个页，该页移动到栈顶。
   - 最近未使用的页在栈底。
   - **问题**：栈操作**需要频繁更新**。

#### 20. 近似LRU算法
1. 附加引用位算法。
2. 二次机会算法。
3. 增强型二次机会算法。

#### 21. 基于计数的页置换分类
1. **最不经常使用页置换算法（LFU）**：经常活动的页有更高引用次数。
2. **最常使用页置换算法（MFU）**：引用次数少的页可能未来更常用。

#### 22. 物理帧的分配方式
1. **平均分配**方式：每个进程分配的物理帧相同。
2. **比例分配**方式：根据进程大小按比例分配。
3. **优先级分配**方式：根据进程优先级分配。

#### 23. 页置换分类
1. **全局置换**：从所有帧中选择一个置换帧，**帧数可能变化**。
2. **局部置换**：从自身帧中选择一个置换帧，**帧数不变化**。

#### 24. 系统颠簸及后果
系统颠簸是一个进程没有足够页帧而**频繁发生页错误**。
**后果**：

1. **CPU使用率**下降，降低**并发度**。
2. 进程**抢占其他进程**帧。

#### 25. 实现文件访问的两种方式
1. **直接操作**磁盘文件。
2. 利用**虚拟内存**技术（**内存映射文件**）。

#### 26. 内存映射文件内容
1. 将**磁盘块**映射为**内存页**。
2. 访问文件会发生**页错误**，文件读写按**内存访问处理**。
3. 写入磁盘操作**定期发生**或在**关闭文件时发生**。

#### 27. 内存映射文件优点
多个进程可将同一文件**映射到各自虚拟内存**中，实现**数据共享**。

#### 28. 内核空间与用户空间分配的区别
1. 不受**分页系统**控制。
2. 通常从**空闲内存池**中获取。
3. 内核需要**连续分配不同大小**的数据结构。

#### 29. Buddy分配
1. 从物理上**连续的、大小固定的段**分配。
2. 内存按**2的幂大小分配**（如2, 4, 8, 16等），直到找到合适页。

#### 30. Slab分配
1. Slab由一个或多个物理连续页组成。
2. Cache包含**一个或多个**Slab。
3. 每个**内核数据结构**有自己的Cache，Cache包含**结构对象实例**。
4. 创建Cache时，初始包含**若干空闲对象**，数量与Slab大小相关。
5. 需要对象时从Cache中**获取并标记为已使用**。