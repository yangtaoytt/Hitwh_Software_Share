### 第4章 线程

[TOC]

#### 1. 引入线程背景
使用多道程序虽然能提高CPU的使用率，但伴随着**性能代价**，如上下文切换。需要更好的办法既能提高**CPU的使用率**又能**减少代价**。

#### 2. 创建线程和创建进程对比
1. 创建进程是**重量级操作**，且进程之间的上下文切换代价较高，因为**PCB**及**许多数据**需要交换。
2. 创建线程**相对简单**，只需复制**栈和寄存器**的内容。

#### 3. 线程共享哪些内容，不共享哪些内容？
1. **共享**：代码段、全局变量、打开的文件标识符、工作环境（如当前目录、用户权限等）。
2. **不共享**：PC寄存器、栈等。

#### 4. 线程和进程的关系
1. 每个线程是**独立的调度对象**。
2. 一个进程可以拥有**单个**或**多个**线程，并**共享内存空间**。

#### 5. 多线程的优点
1. 响应速度**快**：即使部分线程阻塞，其他线程仍可运行。
2. 资源**共享**：共享所属进程的内存和资源。
3. **经济**：创建和切换线程更经济。
4. 多处理器体系结构**利用更充分**：多线程可在多处理器上并行运行。

#### 6. 什么是关系模型？
操作系统的**服务**与**线程**之间存在某种关系，这种关系称为关系模型。

#### 7. 多线程模型都有哪些？
1. 一对一模型（One-to-One Model）。
2. 多对一模型（Many-to-One Model）。
3. 多对多模型（Many-to-Many Model）。
4. 二级模型（Two-Level Model）。

#### 8. 用户线程与内核线程特点
1. **用户线程**：
   - 由用户层**线程库管理**，无需内核管理。
   - 当前主要线程库包括POSIX Pthreads、Win32 Threads、Java Threads。
2. **内核线程**：
   - 由**内核管理**并进行维护和调度。
   - 支持内核线程的操作系统包括Windows、Solaris、Linux、Tru64 UNIX、Mac OS X等。

#### 9. 用户线程和内核线程的关系叫什么？
**用户线程**和**内核线程**之间的关系称为**映射**，可能为一对一、多对一、多对多。

#### 10. 一对一模型定义及优缺点
1. **定义**：
   - 一个用户级线程映射到一个内核级线程，每个用户进程有与用户级线程同数量的内核级线程。
2. **优点**：
   - 一个线程阻塞时，其他线程可继续执行，**并发**能力强。
   - 多线程可在**多核处理器上并行**执行。
3. **缺点**：
   - 占用多个内核级线程，**线程切换需切换到核心态**，管理成本高，开销大。

#### 11. 多对一模型定义及优缺点
1. **定义**：
   - 多个用户级线程映射到一个内核级线程，一个进程只分配一个内核级线程。
2. **优点**：
   - 用户级线程切换在**用户空间**完成，无需切换到核心态，线程**管理开销小**，效率高。
3. **缺点**：
   - 一个用户级线程阻塞时，整个进程都会阻塞，**并发度不高**。
   - 多线程**不可在多核处理器上并行**运行。

#### 12. 多对多模型定义及优缺点
1. **定义**：
   - 多个用户级线程映射到多个内核级线程（n 用户级线程映射到 m 个内核级线程，n ≥ m）。
2. **优点**：
   - 克服多对一模型**并发度不高**的问题。
   - 克服一对一模型中一个用户进程**占用太多内核级线程**的问题。

#### 13. 二级模型定义
二级模型是**多对多**模型的变种，允许用户线程**绑定一个特定的内核线程**。

#### 14. 线程库定义
线程库是为程序员提供的**创建**和**管理**线程的 **API**。

#### 15. 线程库实现方式
1. **非嵌入到内核方式**：在线程库中提供用户空间的实现，无需内核支持。
2. **嵌入到内核方式**：由操作系统直接支持，所有代码和数据结构存在于内核中。

#### 16. 创建线程返回值
1. 创建成功：返回0。
2. 创建失败：返回出错编号。

#### 17. 进程中一个线程调用 fork() 的后果
1. 部分Unix系统提供两种fork()形式：
   - 复制**一个线程**。
   - 复制**全部线程**。
2. **选择依据**：
   - 调用exec()时，复制一个线程。
   - 不调用exec()时，复制全部线程。

#### 18. 线程取消方式
1. **异步取消（Asynchronous Cancellation）**：一个线程**立即终止**目标线程。
2. **延迟取消（Deferred Cancellation）**：目标线程不断检查是否应终止。

#### 19. 线程取消分类
1. **Off Mode**：系统**禁用线程取消**，线程取消待定。
2. **Deferred Mode**：默认状态，**延迟取消**。
3. **Asynchronous Mode**：异步模式，**立即终止**目标线程。

#### 20. 信号的目的
信号（signal）用于通知进程某个特定事件的发生，是操作系统提供的一种**内核**和**进程**间通信机制。

#### 21. 信号的分类
1. **同步信号（内部信号）**：**进程本身事**件产生的信号，如非法内存访问、除零等。
2. **异步信号（外部信号）**：**进程之外事件**产生的信号，如按下CTRL+C键。

#### 22. 信号的处理过程
**信号处理程序**用于处理发生的事件，处理过程如下：

1. 特定事件**产生信号**。
2. 信号**传送给进程**。
3. 信号**处理程序处理**相应信号。

#### 23. 信号处理程序分类
信号处理程序分为**默认信号处理程序**和**用户定义的信号处理程序**。

#### 24. 事件产生信号传递给进程需要考虑的问题
1. 对于单线程进程，无问题。
2. 对于多线程进程：
   - 信号传递给**信号所应用的线程**。
   - 信号传递给进程内**每个线程**。
   - 信号传递给进程**某个固定线程**。
   - **特定线程**接收进程的所有信号。

#### 25. 什么是线程池？
线程池（thread pool）的主要思想是在**进程开始时创建一定数量的线程**，并放入线程池中等待工作。

#### 26. 线程池的优点
1. 使用现有线程处理请求比等待创建新线程**更快**。
2. 线程池**限制可用线程数量**，避免大量创建并发线程，有助于管理。

#### 27. 多对多和二级模型中用户线程与内核线程通信的目的
多对多模型和二级模型中的用户线程与内核线程需要通信，以维持**适当数量的内核线程**。

#### 28. 什么是调度程序激活？
**调度程序激活**是解决**用户线程库**与**内核**之间通信的方法。

#### 29. 调度程序激活的通信机制叫什么？
调度程序激活提供的通信机制称为**UPCALL**。

#### 30. 通信机制的作用
这种通信机制允许应用程序维持适当数量的内核线程。